@startuml authentication
!theme plain
title OurBusWay - Diagramme de Séquence d'Authentification

actor "Utilisateur" as U
participant "Application Web" as APP
participant "Passerelle API" as GW
participant "Microservice Utilisateur" as USER
participant "Microservice Notification" as NOTIF
participant "Base de Données" as DB

== Inscription ==
U -> APP: S'inscrire (email, mot de passe, profil)
APP -> GW: POST /api/users/register
GW -> USER: Valider et créer utilisateur
USER -> DB: Stocker données utilisateur
USER -> NOTIF: Envoyer email de vérification
NOTIF -> NOTIF: Créer et envoyer email
USER --> GW: Inscription réussie
GW --> APP: Succès + vérification requise
APP --> U: Vérifiez votre email

== Connexion ==
U -> APP: Se connecter (email, mot de passe)
APP -> GW: POST /api/users/login
GW -> USER: Authentifier utilisateur
USER -> DB: Vérifier identifiants
alt Identifiants valides
    USER -> USER: Générer tokens JWT
    USER -> DB: Mettre à jour dernière connexion
    USER --> GW: Tokens d'accès et de rafraîchissement
    GW --> APP: Connexion réussie + tokens
    APP --> U: Rediriger vers tableau de bord
else Identifiants invalides
    USER --> GW: 401 Non autorisé
    GW --> APP: Échec de connexion
    APP --> U: Afficher message d'erreur
end

== Rafraîchissement Token ==
APP -> GW: POST /api/users/refresh-token
note right: Authorization: Bearer <refresh_token>
GW -> USER: Valider token de rafraîchissement
alt Token valide
    USER -> USER: Générer nouveaux tokens
    USER --> GW: Nouveaux tokens
    GW --> APP: Tokens mis à jour
else Token invalide
    USER --> GW: 401 Non autorisé
    GW --> APP: Rediriger vers connexion
end

== Déconnexion ==
U -> APP: Se déconnecter
APP -> GW: POST /api/users/logout
GW -> USER: Invalider tokens
USER -> DB: Ajouter tokens à la liste noire
USER --> GW: Déconnexion réussie
GW --> APP: Confirmation
APP --> U: Rediriger vers page de connexion

== Réinitialisation Mot de Passe ==
U -> APP: Mot de passe oublié
APP -> GW: POST /api/users/forgot-password
GW -> USER: Générer token de réinitialisation
USER -> NOTIF: Envoyer email de réinitialisation
NOTIF -> NOTIF: Créer et envoyer email
USER --> GW: Email de réinitialisation envoyé
GW --> APP: Message de vérification email
APP --> U: Vérifiez votre email

U -> APP: Réinitialiser mot de passe avec token
APP -> GW: POST /api/users/reset-password
GW -> USER: Valider token et mettre à jour mot de passe
USER -> DB: Mettre à jour mot de passe
USER -> USER: Invalider toutes les sessions utilisateur
USER --> GW: Mot de passe mis à jour
GW --> APP: Message de succès
APP --> U: Réinitialisation réussie

@enduml
